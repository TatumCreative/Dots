/*! EvolveJS - An HTML5 evolution simulator.
Copyright Greg Tatum under GPL v3.
Last built 2014-02-15 */

var Evo={};Evo.Vector2=function(){var a=function(a,b){this.x=a||0,this.y=b||0};return a.is2d=!0,a.is3d=!1,a.prototype.clone=function(){return new Evo.Vector(this.x,this.y)},a.prototype.copy=function(a){this.x=a.x,this.y=a.y},a.prototype.multiplyScalar=function(a){return"number"==typeof a?(this.x*=a,this.y*=a):(this.x*=a.x,this.y*=a.y),this},a.prototype.divide=function(a){return"number"==typeof a?(this.x/=a,this.y/=a):(this.x/=a.x,this.y/=a.y),this},a.prototype.add=function(a){return"number"==typeof a?(this.x+=a,this.y+=a):(this.x+=a.x,this.y+=a.y),this},a.prototype.subtract=function(a){return"number"==typeof a?(this.x-=a,this.y-=a):(this.x-=a.x,this.y-=a.y),this},a.prototype.abs=function(){return Math.abs(this.x),Math.abs(this.y),this},a.prototype.dot=function(a){return this.x*a.x+this.y*a.y},a.prototype.length=function(){return Math.sqrt(this.dot(this))},a.prototype.distanceTo=function(a){var b=a.clone();return b.subtract(this),b.length()},a.prototype.lengthSqr=function(){return this.dot(this)},a.prototype.lerp=function(a,b){return this.x=this.x+(a.x-this.x)*b,this.y=this.y+(a.y-this.y)*b,this},a.prototype.normalize=function(){if(0!==this.x||0!==this.y){var a=this.length();this.x=this.x/a,this.y=this.y/a}return this},a}(),Evo.Vector=function(){return THREE.Vector2.is2d=!0,THREE.Vector2.is3d=!1,THREE.Vector3.is2d=!1,THREE.Vector3.is3d=!0,THREE.Vector2}(),Evo.VMath=function(){var a={multiplyScalar:function(a,b){var c=a.clone();return c.multiply(b),c},divide:function(a,b){var c=a.clone();return c.divide(b),c},add:function(a,b){var c=a.clone();return c.add(b),c},subtract:function(a,b){var c=a.clone();return c.subtract(b),c},abs:function(a){var b=a.clone();return b.abs(),b},dot:function(a,b){return a.dot(b)},length:function(a){return Math.sqrt(a.dot(a))},distance:function(a,b){var c=a.clone();return c.subtract(b),c.length()},lengthSqr:function(a){return a.dot(a)},lerp:function(a,b,c){var d=a.clone();return d.lerp(b,c),d},normalize:function(a){var b=a.clone();return b.normalize(),b()}};return a}(),Evo.Scene=function(){var a=function(a){Evo.Vector=a||THREE.Vector2,Evo.Vector.is3d?this.backgroundTexture=THREE.ImageUtils.loadTexture("images/tmp_background2.jpg",new THREE.UVMapping,this.start.bind(this)):this.start()};return a.prototype={start:function(){this.loop=new Evo.Loop(this),this.canvas=new Evo.Canvas(this.loop),this.mouse=new Evo.Mouse(this,this.canvas),this.cellFactory=new Evo.CellFactory(this),Evo.Behavior.GrowAndDivide.prototype.setBindings(),Evo.Binding.prototype.hashToModel(),Evo.Vector.is3d&&(Evo.ExtendSceneTo3d(a.prototype),this.setup3d(),this.loop.registerDraw(this)),this.cellFactory.start(),this.loop.start()}},a}(),Evo.Binding=function(){var a=function(b,c,d){this.domId=b,this.$view=$("#"+b),this.getter=c,this.setter=d,this.$view.on("change.Evo-Binding",this.updateModel.bind(this)),this.updateView(),a.prototype._allBindings.push(this)};return a.prototype={_allBindings:[],modelToHash:function(){for(var b=a.prototype._allBindings,c=[],d=0,e=b.length;e>d;d++)c.push({name:b[d].domId,value:b[d].getViewValue()});window.location.hash="/?"+$.param(c)},hashToModel:function(){for(var b=function(a){if(""===a)return{};for(var b=[],c=0;c<a.length;++c){var d=a[c].split("=");2===d.length&&b.push({name:d[0],value:decodeURIComponent(d[1].replace(/\+/g," "))})}return b}(window.location.hash.substr(3).split("&")),c=a.prototype._allBindings,d=0,e=b.length,f=0,g=c.length;e>d;d++)for(f=0;g>f;f++)c[f].domId===b[d].name&&void 0!==b[d].name&&(c[f].updateView(b[d].value),c[f].updateModel())},getViewValue:function(){return void 0!==this.$view[0]?this.$view.is("input[type='radio']")?this.$view.is(":checked").val():this.$view.is("input")?this.$view.val():this.$view.html():void 0},updateModel:function(){var a=this.getViewValue();this.setter(a),this.updateView()},updateView:function(a){void 0===a&&(a=this.getter()),void 0!==this.$view[0]&&(this.$view.is("input[type='radio']")||(this.$view.is("input")?this.$view.val(a):this.$view.html(a)))},remove:function(){a.prototype._allBindings.splice(a.prototype._allBindings.indexOf(this),1),this.$view=null,this.getter=null,this.setter=null,this.$view.off("change.Evo-Binding",this.updateModel)}},a}(),Evo.Canvas=function(){var a=function(a){this.loop=a,this.ratio=window.devicePixelRatio>=1?window.devicePixelRatio:1,this.$el=$("canvas"),this.el=this.$el.get(0),Evo.Vector.is3d||(this.context=this.el.getContext("2d"),this.loop.registerDraw(this)),this.resize(),$(window).on("resize",this.resize.bind(this))};return a.prototype={resize:function(a){this.el.width=$(window).width()*this.ratio,this.el.height=$(window).height()*this.ratio,this.width=this.el.width,this.height=this.el.height,this.left=this.$el.offset().left,this.top=this.$el.offset().top,a&&this.loop&&(this.loop.runUpdateListeners(0),this.loop.runDrawListeners(0))},draw:function(){this.context.clearRect(0,0,this.width,this.height)}},a}(),Evo.Mouse=function(){var a=function(a,b){this.position=new Evo.Vector(-1e4,-1e4),this.canvas=b,this.scene=a,this.drawRadius=100,Evo.Vector.is2d?(document.addEventListener("mousemove",this.onMouseMove.bind(this)),document.addEventListener("touchmove",this.onTouchMove.bind(this)),document.addEventListener("touchend",this.onTouchEnd.bind(this)),this.scene.loop.registerDraw(this)):(this.mouse3D=new Evo.Vector(-1e5,-1e5,0),this.projector=new THREE.Projector,this.ray=new THREE.Ray,this.ray.set(new Evo.Vector(-1e4,-1e4,0),new Evo.Vector(0,0,1)),document.addEventListener("mousemove",this.onMouseMove3d.bind(this)),document.addEventListener("touchmove",this.onTouchMove.bind(this)),document.addEventListener("touchend",this.onTouchEnd.bind(this))),document.ontouchstart=function(a){a.preventDefault()}};return a.prototype={draw:function(){this.canvas.context.strokeStyle="rgba(140,0,0,0.4)",this.canvas.context.arc(this.position.x,this.position.y,this.drawRadius,0,2*Math.PI,!1),this.canvas.context.lineWidth=5,this.canvas.context.stroke()},onMouseMove:function(a){"number"==typeof a.pageX&&a.pageX>this.canvas.left?(this.position.x=(a.pageX-this.canvas.left)*window.devicePixelRatio,this.position.y=(a.pageY-this.canvas.top)*window.devicePixelRatio):(this.position.x=-1e5,this.position.y=-1e5)},onMouseMove3d:function(a){"number"==typeof a.pageX&&a.pageX>this.canvas.left?(this.mouse3D.x=(a.pageX-this.canvas.left)/this.canvas.width*2-1,this.mouse3D.y=2*-(a.pageY/(this.canvas.height-this.canvas.top))+1,this.mouse3D.z=.5,this.mouse3d.multiplyScalar(window.devicePixelRatio),this.projector.unprojectVector(this.mouse3D,this.scene.camera),this.ray.set(this.scene.camera.position,this.mouse3D.sub(this.scene.camera.position).normalize()),this.position.x=a.pageX-this.canvas.left,this.position.y=a.pageY-this.canvas.top):(this.position.x=-1e5,this.position.y=-1e5)},onTouchMove:function(a){a.touches&&(this.position.x=a.touches[0].pageX-this.canvas.left,this.position.y=a.touches[0].pageY-this.canvas.top,this.position.multiplyScalar(window.devicePixelRatio))},onTouchEnd:function(){this.position.x=-1e5,this.position.y=-1e5},setDrawRadius:function(a){this.drawRadius=a},setPosition:function(a,b){this.position.x=a,this.position.y=b,this.position.multiplyScalar(window.devicePixelRatio)},getPosition:function(){return this.position},getX:function(){return this.position.x},getY:function(){return this.position.y}},a}(),Evo.UI=function(){this.startUniform(),this.sectionNavigator=new Evo.SectionNavigator,this.contentIntro=new Evo.UI.Content.Intro,this.$menu=$(".menu"),window.addEventListener("shake",this.onShakeHideUI.bind(this),!1)},Evo.UI.prototype={startUniform:function(){$("input, select, textarea").uniform()},onShakeHideUI:function(){this.$menu.toggleClass("shaken")}},Evo.UI.Content={},Evo.Utilities={extend:function(a,b){$().extend(a.prototype,a.prototype,b.prototype),a.prototype.parent=b},rgbToFillstyle:function(a,b,c,d){return void 0===d?["rgb(",a,",",b,",",c,")"].join(""):["rgba(",a,",",b,",",c,",",d,")"].join("")}},Evo.BehaviorManager=function(){var a=function(){this.currentBehaviors=[]};return a.prototype={update:function(a){for(var b in this.currentBehaviors)this.currentBehaviors[b].update(a)},add:function(a){this.currentBehaviors.indexOf(a)>=0||("function"==typeof a.onAdd&&a.onAdd(),a.manager=this,this.currentBehaviors.push(a))},remove:function(a){var b=this.currentBehaviors.indexOf(a);b>=0&&("function"==typeof this.currentBehaviors[b]&&this.currentBehaviors[b].onRemove(),this.currentBehaviors[b].manager=null,this.currentBehaviors.splice(b,1))},has:function(a){return this.currentBehaviors.indexOf(a)>=0},destroy:function(){for(var a=0;a<this.currentBehaviors.length;++a)this.currentBehaviors[a].actor=null,"function"==typeof this.currentBehaviors[a].destroy&&this.currentBehaviors[a].destroy();this.currentBehaviors.length=0},revert:function(){for(var a=0;a<this.currentBehaviors.length;++a)"function"==typeof this.currentBehaviors[a].revert&&this.currentBehaviors[a].revert()}},a}(),Evo.Behavior={},Evo.Behavior.Boids2d=function(){var a=function(a){Evo.Vector.is3d&&console.warn("Boids are not 3d capable"),this.actor=a,this.speed=.05,this.neighborsDirection=new Evo.Vector(0,0),this.neighborsPosition=new Evo.Vector(0,0),this.neighborsPositionSum=new Evo.Vector(0,0),this.direction=new Evo.Vector(2*Math.random()-1,2*Math.random()-1)};return a.prototype.update=function(){if(this.actor.gridNode){var a=this.actor.gridNode._nodeStack,b=0,c=a.length;for(this.neighborsDirection.x=0,this.neighborsDirection.y=0;c>b;b++)this.neighborsDirection.x+=a[b].direction.x,this.neighborsDirection.y+=a[b].direction.y,this.neighborsPosition.x=a[b].position.x-this.actor.position.x,this.neighborsPosition.y=a[b].position.y-this.actor.position.x,this.neighborsPosition.normalize(),this.neighborsPositionSum.add(this.neighborsPosition);c>0&&this.neighborsPositionSum.divide(c),(this.neighborsDirection.x>0||this.neighborsDirection.y>0)&&this.neighborsDirection.normalize(),this.actor.addWeightedDirection(this.neighborsDirection,.01),this.actor.addWeightedDirection(this.neighborsPositionSum,1)}},a.prototype.onAdd=function(){},a.prototype.onRemove=function(){},a}(),Evo.Behavior.DieRandomly=function(){var a=function(a,b){this.actor=a,this.cellFactory=b};return a.prototype.update=function(){Math.random()<.001&&this.cellFactory.cellIsDead(this.actor)},a.prototype.onAdd=function(){},a.prototype.onRemove=function(){},a}(),Evo.Behavior.DieWhenCrowded=function(){var a=function(a,b){this.actor=a,this.cellFactory=b};return a.prototype.update=function(){Math.random()<.2*(this.cellFactory.getLiveCellCount()/this.cellFactory.maxCells)&&Math.random()<.05*(this.actor.age/1e4)&&this.cellFactory.cellIsDead(this.actor)},a.prototype.onAdd=function(){},a.prototype.onRemove=function(){},a}(),Evo.Behavior.FleeMouse2d=function(){var a=function(a,b,c,d){this.actor=a,this.mouse=b,this.direction=new Evo.Vector,this.distanceToMouse=0,this.speed=0,this.maxWeight=2,this.weight=0,this.fleeSpeed=c,this.fleeDistance=d,this.prevDirection=new Evo.Vector(0,0,0),this.prevSpeed=0,this.interpolationAmount=1};return a.prototype.update=function(a){this.direction.subVectors(this.actor.position,this.mouse.getPosition()),this.distanceToMouse=this.direction.length(),this.speed=Math.max(0,this.fleeDistance-this.distanceToMouse)/this.fleeSpeed,this.weight=Math.max(0,this.fleeDistance-this.distanceToMouse)/this.fleeDistance*this.maxWeight,this.interpolationAmount=Math.min(1,1-a/500),this.speed=this.speed+(this.prevSpeed-this.speed)*this.interpolationAmount,this.speed>0?(this.direction.normalize(),this.actor.addWeightedDirection(this.direction,this.weight),this.actor.addWeightedSpeed(this.speed,this.weight)):this.speed=0,this.prevDirection=this.direction,this.prevSpeed=this.speed},a.prototype.onAdd=function(){},a.prototype.onRemove=function(){},a}(),Evo.Behavior.FleeMouse3d=function(){var a=function(a,b,c,d){this.actor=a,this.mouse=b,this.closestPointToMouseRay=new Evo.Vector(0,0,0),this.direction=new Evo.Vector(0,0,0),this.distanceToMouse=0,this.speed=0,this.maxWeight=2,this.weight=0,this.fleeSpeed=c,this.fleeDistance=d,this.prevDirection=new Evo.Vector(0,0,0),this.prevSpeed=0,this.interpolationAmount=1};return a.prototype.update=function(a){this.mouse.ray.closestPointToPoint(this.actor.position,this.closestPointToMouseRay),this.direction.subVectors(this.actor.position,this.closestPointToMouseRay),this.distanceToMouse=this.direction.length(),this.speed=Math.max(0,this.fleeDistance-this.distanceToMouse)/this.fleeSpeed,this.weight=Math.max(0,this.fleeDistance-this.distanceToMouse)/this.fleeDistance*this.maxWeight,this.interpolationAmount=Math.min(1,1-a/500),this.speed=this.speed+(this.prevSpeed-this.speed)*this.interpolationAmount,this.speed>0?(this.direction.normalize(),this.actor.addWeightedDirection(this.direction,this.weight),this.actor.addWeightedSpeed(this.speed,this.weight)):this.speed=0,this.prevDirection.copy(this.direction),this.prevSpeed=this.speed},a}(),Evo.Behavior.FleeWalls=function(a,b){return Evo.Vector.is2d?new Evo.Behavior.FleeWalls2d(a,b):new Evo.Behavior.FleeWalls3d(a,b)},Evo.Behavior.FleeWalls2d=function(){var a=function(a,b){this.actor=a,this.canvas=b,this.MARGIN=(this.canvas.width+this.canvas.height)/4,this.direction=new Evo.Vector,this.weight=0};return a.prototype.update=function(){this.direction.multiplyScalar(0),this.actor.position.x<this.MARGIN&&(this.direction.x=(this.MARGIN-this.actor.position.x)/this.MARGIN),this.actor.position.y<this.MARGIN&&(this.direction.y=(this.MARGIN-this.actor.position.y)/this.MARGIN),this.actor.position.x>this.canvas.width-this.MARGIN&&(this.direction.x=-1*((this.MARGIN-(this.canvas.width-this.actor.position.x))/this.MARGIN)),this.actor.position.y>this.canvas.height-this.MARGIN&&(this.direction.y=-1*((this.MARGIN-(this.canvas.height-this.actor.position.y))/this.MARGIN)),(0!==this.direction.x||0!==this.direction.y)&&(this.weight=this.direction.x*this.direction.x+this.direction.y*this.direction.y,this.direction.normalize(),this.actor.addWeightedDirection(this.direction,2*this.weight))},a}(),Evo.Behavior.FleeWalls3d=function(a,b){this.actor=a,this.canvas=b,this.MARGIN=0,this.origin=new THREE.Vector3(0,75,0),this.direction=new THREE.Vector3(0,0,0),this.distance=0,this.fleeStarts=100,this.fleeStartsSquared=Math.pow(this.fleeStarts,2),this.fleeEnds=250,this.fleeEnds=Math.pow(this.fleeEnds,2),this.fleeDenominator=this.fleeEnds-this.fleeStarts,this.direction=new THREE.Vector3(0,0,0),this.weight=0},Evo.Behavior.FleeWalls3d.prototype.update=function(){this.distance=this.origin.distanceToSquared(this.actor.position),this.distance>this.fleeStartsSquared&&(this.direction.copy(this.actor.position).normalize().negate(),this.weight=(this.distance-this.fleeStartsSquared)/this.fleeDenominator,this.actor.addWeightedDirection(this.direction,1*this.weight))},Evo.Behavior.GrowAndDivide=function(){var a=function(a,b,c,d){this.actor=a,this.cellFactory=b,this.growthSpeed=c,this.dividingFactor=d,this.divideSize=0,this.revert()};return a.prototype.GROWTHFACTOR=.005,a.prototype.update=function(){this.actor.size=this.actor.size+this.actor.energy*this.GROWTHFACTOR*this.birthSize,this.actor.energy=0,this.actor.size>this.divideSize&&(this.actor.size=this.divideSize,this.cellFactory.divideCell(this.actor))},a.prototype.revert=function(){this.birthSize=this.actor.phenome.get("birthSize"),this.divideSize=this.birthSize*this.dividingFactor},a.prototype.setBindings=function(){new Evo.Binding("growthfactor",function(){return a.prototype.GROWTHFACTOR},function(b){b=parseFloat(b,10),a.prototype.GROWTHFACTOR=b}.bind(this))},a}(),Evo.Behavior.Roam=function(){var a=function(a){this.actor=a,this.speed=.05,this.direction=new Evo.Vector,this.direction.x=2*Math.random()-1,this.direction.y=2*Math.random()-1,Evo.Vector.is3d&&(this.direction.z=2*Math.random()-1),this.elapsedTime=0};return a.prototype.update=function(a){this.direction.x=Math.min((Math.random()-.5)/10+this.direction.x,1),this.direction.y=Math.min((Math.random()-.5)/10+this.direction.y,1),Evo.Vector.is3d&&(this.direction.z=Math.min((Math.random()-.5)/10+this.direction.z,1)),this.actor.addWeightedDirection(this.direction,1),this.actor.addWeightedSpeed(this.speed,1),this.elapsedTime+=a},a}(),Evo.CellFactory=function(){var a=function(a){this.scene=a,this.grid=null,this.oldestGeneration=1,this.maxCells=Evo.Vector.is2d?1500:400,this.cellStartCount=parseInt(this.maxCells/15,10),this.killDistance=100,this.killDistanceSq=Math.pow(this.killDistance,2),this.scene.mouse.setDrawRadius(this.killDistance),this.energyGenerator=new Evo.EnergyGenerator(this.scene,this),this.cells=[],this.deadCells=[],this.lastTapTimestamp=0,this.setBindings(),Evo.Cell.prototype.setBindings(),Evo.Phenotype.prototype.setBindings(),Evo.Vector.is2d?($(this.scene.canvas.el).on("mousedown",this.mouseKillCells2d.bind(this)),$(this.scene.canvas.el).on("touchstart",this.doubleTap.bind(this))):$(this.scene.canvas.el).on("mousedown",this.mouseKillCells3d.bind(this)),$("#CellFactory-Restart").click(this.restart.bind(this)),$(window).on("resize",this.rebuildGrid.bind(this))};return a.prototype={update:function(){},draw:function(){},start:function(){this.generateCells(this.maxCells);for(var a,b=0;b<this.cellStartCount;b++)a=this.deadCells.pop(),a.setToAlive()},generateCells:function(a){var b,c;for(c=this.maxCells-a;a>c;c++)b=new Evo.Cell(this.scene,this.grid,this.energyGenerator,this.getStartingVector(),Math.random()),this.deadCells.push(b),this.addBehaviors(b),b.i=c,this.cells[c]=b},getStartingVector:function(a){if(a||(a=new Evo.Vector),Evo.Vector.is2d)return a.set(this.scene.canvas.width*Math.random(),this.scene.canvas.height*Math.random()),a;var b=500;return new a.set(b/2-b*Math.random(),b/2-b*Math.random(),b/2-b*Math.random()),a},restart:function(){this.killAllCells(),this.start(),this.oldestGeneration=0},cellIsDead:function(a){var b=this.deadCells.indexOf(a);-1===b&&this.deadCells.push(a),a.setToDead()},rebuildGrid:function(){},killAllCells:function(){for(var a=0,b=this.cells.length;b>a;a++)this.cells[a].alive&&this.deadCells.push(this.cells[a]),this.cells[a].setToDead()},doubleTap:function(a){this.scene.mouse.setPosition(a.originalEvent.touches[0].pageX,a.originalEvent.touches[0].pageY),Evo.Vector.is2d?this.mouseKillCells2d(a):this.mouseKillCells3d(a),this.lastTapTimestamp=a.timeStamp},mouseKillCells2d:function(a){a&&a.preventDefault();for(var b=this.scene.mouse.position.clone(),c=0,d=this.cells.length;d>c;c++)this.cells[c].position.distanceTo(b)<this.killDistance&&this.cellIsDead(this.cells[c])},mouseKillCells3d:function(a){a&&a.preventDefault();for(var b=0,c=this.cells.length;c>b;b++)this.scene.mouse.ray.distanceToPoint(this.cells[b].position)<this.killDistance&&this.cellIsDead(this.cells[b])},addBehaviors:function(a){a.behaviorManager.add(new Evo.Behavior.Roam(a)),a.behaviorManager.add(new Evo.Behavior.GrowAndDivide(a,this,a.phenome.get("growthRate"),1.5)),a.behaviorManager.add(new Evo.Behavior.DieWhenCrowded(a,this)),a.behaviorManager.add(new Evo.Behavior.FleeWalls(a,this.scene.canvas)),Evo.Vector.is2d?a.behaviorManager.add(new Evo.Behavior.FleeMouse2d(a,this.scene.mouse,a.phenome.get("fleeSpeed"),a.phenome.get("fleeDistance"))):a.behaviorManager.add(new Evo.Behavior.FleeMouse3d(a,this.scene.mouse,a.phenome.get("fleeSpeed"),a.phenome.get("fleeDistance")))},divideCell:function(a){if(0!==this.deadCells.length){var b=this.deadCells.pop();b.copy(a),a.phenome.mutate(),b.phenome.mutate(),a.revert(),b.revert(),b.setToAlive(),this.oldestGeneration=Math.max(a.generation,this.oldestGeneration)}},getLiveCells:function(){return this.cells.filter(function(a){return a.alive})},getLiveCellCount:function(){return this.maxCells-this.deadCells.length},getAveragePositions:function(){var a=new THREE.Vector3;return function(b){var c=b||new THREE.Vector3;return c.set(0,0,0),this.cells.filter(function(a){return a.alive}).reduce(function(b,d,e,f){return a.copy(d.position),c.add(a.divideScalar(f.length))})}}(),setMaxCells:function(a){if(a>this.maxCells&&this.generateCells(a),a<this.maxCells)for(var b=this.cells.length-1;b>=a;)this.cells[b].destroy(),this.cells.pop(),b--;this.maxCells=a},setBindings:function(){new Evo.Binding("startcount",function(){return this.cellStartCount}.bind(this),function(a){a=parseInt(a,10),a=a>0?a:1,this.cellStartCount=a}.bind(this)),new Evo.Binding("maxcells",function(){return this.maxCells}.bind(this),function(a){a=parseInt(a,10),a=a>0?a:1,a=Math.min(a,1e4),this.setMaxCells(a)}.bind(this)),new Evo.Binding("killdistance",function(){return this.killDistance}.bind(this),function(a){a=parseInt(a,10),a=a>0?a:1,this.scene.mouse.setDrawRadius(a),this.killDistance=a}.bind(this))}},a}(),Evo.EnergyGenerator=function(){var a=function(a,b){this.energyPerMillisecond=.005*b.maxCells,this.energy=0,this.energyPerActor=0,this.cellFactory=b,this.scene=a,this.scene.loop.registerUpdate(this),this.setBindings()};return a.prototype={update:function(a){this.energy=this.energyPerMillisecond*a,this.energyPerActor=this.energy/this.cellFactory.getLiveCellCount()},get:function(){return this.energyPerActor},setBindings:function(){new Evo.Binding("energypersecond",function(){return this.energyPerMillisecond}.bind(this),function(a){a=parseFloat(a,10),a=Math.max(a,0),this.energyPerMillisecond=a}.bind(this))}},a}(),Evo.Phenotype=function(){var a=function(a){this.value=a};return a.prototype={mutationRate:.5,mutationFactor:5,mutate:function(a,b,c){Math.random()<this.mutationRate&&(this.value*=(.5-Math.random()+this.mutationFactor)/this.mutationFactor,void 0!==a&&(this.value=Math.max(this.value,a)),void 0!==b&&(this.value=Math.min(this.value,b)),c&&(this.value=parseInt(this.value,10)))},setBindings:function(){new Evo.Binding("mutationrate",function(){return a.prototype.mutationRate},function(b){b=parseFloat(b),b=Math.max(b,0),b=Math.min(b,1),a.prototype.mutationRate=b}),new Evo.Binding("mutationfactor",function(){return 1/a.prototype.mutationFactor},function(b){b=1/b,b=parseFloat(b),b=Math.max(b,1e-5),b=Math.min(b,1e3),a.prototype.mutationFactor=b})}},a}(),Evo.Grid=function(){var a=function(a,b,c,d,e){this.scene=a,this.gridWidth=b,this.gridHeight=c,this.pixelWidth=d,this.pixelHeight=e,this.nodeLength=0,this.scene.loop.registerDraw(this),this.create()};return a.prototype={create:function(){var a=this.gridWidth,b=this.gridHeight;for(this.gridNodes=[];a--;)for(this.gridNodes[a]=new Array(this.gridHeight),b=this.gridHeight;b--;)this.gridNodes[a][b]=new Evo.GridNode},destroy:function(){for(var a=this.gridWidth,b=this.gridHeight;a--;){for(b=this.gridHeight;b--;)this.gridNodes[a][b].destroy();this.gridNodes[a].length=0}this.gridNodes.length=0,this.gridNodes=null},emptyAllItems:function(){for(var a=this.gridWidth,b=this.gridHeight;a--;)for(b=this.gridHeight;b--;)this.gridNodes[a][b].empty();this.nodeLength=0},resize:function(a,b){this.pixelWidth=a,this.pixelHeight=b,this.emptyAllItems()},removeItems:function(a){for(var b=a.length;b--;)this.removeItem(a[b]),this.nodeLength--},removeItem:function(a){a.gridNode&&(a.gridNode.remove(a),this.nodeLength--)},updateItem:function(a,b,c){var d=this.pixelsToGridNode(b,c);d!==a.gridNode&&(a.gridNode&&(a.gridNode.remove(a),this.nodeLength--),d.add(a),this.nodeLength++)},draw:function(){var a,b,c=this.gridWidth,d=this.gridHeight,e=this.pixelWidth/this.gridWidth,f=this.pixelHeight/this.gridHeight;for(this.scene.canvas.context.strokeStyle="rgba(0,50,0,0.2)";c--;)for(d=this.gridHeight;d--;)this.scene.canvas.context.fillStyle="rgba(0,110,255,"+Math.min(.2,.5*this.gridNodes[c][d].length()/(this.nodeLength+1))+")",a=c/this.gridWidth*this.pixelWidth,b=d/this.gridHeight*this.pixelHeight,this.scene.canvas.context.fillRect(a,b,e,f)},pixelsToGridNode:function(a,b){var c=this.pixelsToGridSpace(a,b);return this.gridNodes[c.x][c.y]},pixelsToGridSpace:function(a,b){var c=new Evo.Vector;return c.x=Math.floor(this.gridWidth*(a/this.pixelWidth)),c.y=Math.floor(this.gridHeight*(b/this.pixelHeight)),c.x=Math.max(c.x,0),c.y=Math.max(c.y,0),c.x=Math.min(c.x,this.gridWidth-1),c.y=Math.min(c.y,this.gridWidth-1),c},pixelsToItems:function(b,c){var d=a.pixelsToGridSpace(b,c);return this.gridNodes[d.x][d.y].getAllItems()},pixelsAndGridRadiusToItems:function(b,c,d){for(var e,f,g=a.pixelsToGridSpace(b,c),h=-1*d,i=h,j=[];d>=h;){for(e=(g.x+h)%this.gridWidth;d>=i;)f=(g.y+i)%this.gridHeight,j.concat(this.gridNodes[h][i].getAllItems()),i++;h++}return j}},a}(),Evo.GridNode=function(){var a=function(){this._nodeStack=[]};return a.prototype={add:function(a){return-1===this._nodeStack.indexOf(a)?(this._nodeStack.push(a),a.gridNode=this,!0):!1},remove:function(a){this._nodeStack.splice(this._nodeStack.indexOf(a),1),a.gridNode=null},getAllItems:function(){return this._nodeStack.slice(0)},length:function(){return this._nodeStack.length},destroy:function(){this._nodeStack.length=0},empty:function(){this.destroy()}},a}(),Evo.Random=function(){function a(a){this.seed=a||10}return a.prototype={get:function(){return Math.random()},getInt:function(a,b){return parseInt(this.get(a,b),10)}},a}(),Evo.ExtendSceneTo3d=function(a){$.extend(a,{setup3d:function(){this.renderer=void 0,this.div=document.getElementById("evo"),this.scene=new THREE.Scene,this.cameraFov=50,this.camera=new THREE.PerspectiveCamera(this.cameraFov,this.canvas.width/this.canvas.height,1,5e3),this.camera.position.x=(this.canvas.width+this.canvas.height)/4,this.camera.position.y=(this.canvas.width+this.canvas.height)/4,this.camera.position.z=(this.canvas.width+this.canvas.height)/4,console.log(this.camera.position),this.controls=new THREE.OrbitControls(this.camera,this.canvas.el),this.controls.noZoom=!0,this.addRenderer(),this.addLights(),this.addGrid(),this.addEventListeners()},addLights:function(){this.lights=[],this.lights[0]=new THREE.AmbientLight(16777215),this.lights[1]=new THREE.PointLight(16777215,1,0),this.lights[2]=new THREE.PointLight(16777215,1,0),this.lights[3]=new THREE.PointLight(16777215,1,0),this.lights[1].position.set(0,200,0),this.lights[2].position.set(100,200,100),this.lights[3].position.set(-100,-200,-100),this.scene.add(this.lights[1]),this.scene.add(this.lights[2]),this.scene.add(this.lights[3])},addGrid:function(){for(var a=new THREE.LineBasicMaterial({color:12632304}),b=new THREE.Geometry,c=-75,d=25,e=0;40>=e;e++)b.vertices.push(new THREE.Vector3(-500,c,e*d-500)),b.vertices.push(new THREE.Vector3(500,c,e*d-500)),b.vertices.push(new THREE.Vector3(e*d-500,c,-500)),b.vertices.push(new THREE.Vector3(e*d-500,c,500));this.grid=new THREE.Line(b,a,THREE.LinePieces),this.scene.add(this.grid),this.grid.scale.multiplyScalar(3)},addRenderer:function(){this.renderer=new THREE.WebGLRenderer({canvas:this.canvas.el}),this.renderer.setSize(this.canvas.width,this.canvas.height),this.div.appendChild(this.renderer.domElement)},addEventListeners:function(){$(window).on("resize",this.resizeHandler.bind(this)),this.canvas.el.addEventListener("mousewheel",this.onMouseWheel.bind(this),!1),this.canvas.el.addEventListener("DOMMouseScroll",this.onMouseWheel.bind(this),!1)},addBackground:function(){this.backgroundMesh=new THREE.Mesh(new THREE.SphereGeometry(3e3,60,40),new THREE.MeshBasicMaterial({map:this.backgroundTexture})),this.backgroundMesh.scale.x=-1,this.scene.add(this.backgroundMesh)},resizeHandler:function(){console.log("resizing"),this.camera.aspect=this.canvas.width/this.canvas.height,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.canvas.width,this.canvas.height)},onMouseWheel:function(a){a.preventDefault(),a.wheelDeltaY?this.cameraFov-=.05*a.wheelDeltaY:a.wheelDelta?this.cameraFov-=.05*a.wheelDelta:a.detail&&(this.cameraFov+=1*a.detail),this.cameraFov=Math.min(this.cameraFov,140),this.cameraFov=Math.max(this.cameraFov,20),this.camera.projectionMatrix.makePerspective(this.cameraFov,this.canvas.width/this.canvas.height,1,5e3)},draw:function(){this.controls.rotateLeft(5e-4),this.controls.update(),this.renderer.render(this.scene,this.camera)}})},Evo.Loop=function(){var a=function(a){this.scene=a,this._animationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setInterval(a,1e3/60)},this._isPlaying=!1,this._updateListeners=[],this._drawListeners=[],this._updateLength=0,this._drawLength=0,this._uI=0,this._dI=0,this._timePresent=0,this._timePast=0,this._dt=0,$("#Loop-Pause").on("mouseup",this.pauseHandler.bind(this))};return a.prototype={registerUpdate:function(a){this._updateListeners.push(a),this._updateLength=this._updateListeners.length},registerDraw:function(a){this._drawListeners.push(a),this._drawLength=this._drawListeners.length},removeUpdate:function(a){var b=this._updateListeners.indexOf(a);b>=0&&(this._updateListeners.splice(b,1),this._updateLength--)},removeDraw:function(a){var b=this._drawListeners.indexOf(a);b>=0&&(this._drawListeners.splice(b,1),this._drawLength--)},updateTime:function(){this._timePresent=(new Date).getTime(),this._dt=Math.min(this._timePresent-this._timePast,500),this._timePast=this._timePresent},runUpdateListeners:function(a){for(this._uI=0;this._uI<this._updateLength;++this._uI)this._updateListeners[this._uI].update(a)},runDrawListeners:function(a){for(this._dI=0;this._dI<this._drawLength;++this._dI)this._drawListeners[this._dI].draw(a)},mainLoop:function(){this._isPlaying&&this._animationFrame.call(window,this.mainLoop.bind(this),this.scene.canvas.el),this.updateTime(),this.runUpdateListeners(this._dt),this.runDrawListeners(this._dt)},pauseHandler:function(a){a&&a.preventDefault(),this._isPlaying?($("#Loop-Pause").val("Play"),this.stop()):($("#Loop-Pause").val("Pause"),this.start()),$.uniform.update("#Loop-Pause")},start:function(){this._isPlaying=!0,this._timePast=(new Date).getTime(),this.mainLoop()},stop:function(){this._isPlaying=!1}},a}(),Evo.UI.Content.Intro=function(){this.readMoreLink(),this.start2d(),this.start3d(),this.doToggleAnimation=!0,this.toggleAnimation()},Evo.UI.Content.Intro.prototype={toggleAnimation:function(){this.doToggleAnimation&&($(".content-back1, .content-back2").toggleClass("animate"),setTimeout(this.toggleAnimation.bind(this),19990))},readMoreLink:function(){var a=$("#content-intro-read-more-link");a.click(function(){return a.hide(),$("#content-intro-read-more").slideDown(),!1})},start2d:function(){var a=$("#content-intro-start-2d");window.CanvasRenderingContext2D||(a.attr("disabled","disabled"),a.val("No 2d mode"),a.uniform()),a.click(function(){return this.doToggleAnimation=!1,$(".menu-logo-area").addClass("show"),$("#ui-show-controls").removeClass("hide"),window.evo=new Evo.Scene(THREE.Vector2),$(".content").hide(),!1})},start3d:function(){var a=$("#content-intro-start-3d");(function(){try{var a=document.createElement("canvas");return!!window.WebGLRenderingContext&&(a.getContext("webgl")||a.getContext("experimental-webgl"))}catch(b){return!1}})()||(a.attr("disabled","disabled"),a.val("No 3d mode"),a.uniform()),a.click(function(){return this.doToggleAnimation=!1,$(".menu-logo-area").addClass("show"),$("#ui-show-controls").removeClass("hide"),window.evo=new Evo.Scene(THREE.Vector3),$(".content").hide(),!1})}},Evo.SectionNavigator=function(){var a=function(){this.transitionSpeed=500,this.$level1=$("#level1"),this.$level2=$("#level2"),this.$wrapper=$(".section-wrapper"),this.$menuControls=$(".menu-controls"),this.$menuControlsButton=$("#ui-show-controls"),this.$menuHideControlsButton=$("#ui-hide-controls"),this.$wrapper.addClass("level1-showing"),this.$menuControlsButton.on("mouseup",this.toggleControls.bind(this)),this.$menuHideControlsButton.on("mouseup",this.toggleControls.bind(this)),$(".section-navigator input[type=button]").on("mouseup",this.showLevel1.bind(this)),$(".back-button-input").on("mouseup",this.showLevel2.bind(this)),$("#Binding-toHash").on("mouseup",Evo.Binding.prototype.modelToHash)};return a.prototype={toggleControls:function(a){return a&&a.preventDefault(),this.$menuControls.toggleClass("show"),this.$menuControlsButton.toggleClass("hide"),!1},showLevel1:function(a){a&&a.preventDefault();var b=$(a.target).attr("data-id-show");
return b&&($("#"+b).addClass("show"),this.$wrapper.removeClass("level1-showing"),this.$wrapper.addClass("level2-showing")),!1},showLevel2:function(a){return a&&a.preventDefault(),this.$level2.find("fieldset").removeClass("show"),this.$wrapper.addClass("level1-showing"),this.$wrapper.removeClass("level2-showing"),!1}},a}(),Evo.Cell=function(){var a=function(a,b,c,d){this.scene=a,this.grid=b,this.energyGenerator=c,this.behaviorManager=new Evo.BehaviorManager,this.position=d,this.direction=new Evo.Vector(1,0,0),this.bounds=new Evo.Vector(this.scene.canvas.width,this.scene.canvas.height,1),this.speed=0,this.age=0,this.energy=100,this.alive=!1,this.generation=1,this.weightedDirection=new Evo.Vector(0,0,0),this.weightedSpeed={speed:0,weight:0},Evo.Vector.is3d&&this.setup3d(),this.phenome=new Evo.Phenome,this.phenome.generate(),this.revert()};return a.prototype={SPEEDCOST:.05,setToAlive:function(){this.alive||(this.alive=!0,Evo.Vector.is2d?this.scene.loop.registerDraw(this):this.scene.scene.add(this.object3d),this.scene.loop.registerUpdate(this))},setToDead:function(){this.alive&&(this.alive=!1,this.scene.loop.removeDraw(this),this.scene.loop.removeUpdate(this),Evo.Vector.is3d&&this.scene.scene.remove(this.object3d))},setup3d:function(){var a=(this.scene.canvas.width+this.scene.canvas.height)/2;this.bounds=new Evo.Vector(a,a,a),this.geometry=new THREE.CubeGeometry(5,5,5),this.material=new THREE.MeshPhongMaterial({color:0,specular:new THREE.Color(16777215),shininess:Math.pow(10,2),emissive:new THREE.Color,shading:THREE.NoShading,wireframe:!1,wireframeLinewidth:3}),this.object3d=new THREE.Mesh(this.geometry,this.material),this.object3d.position=this.position},destroy:function(){this.setToDead(),this.behaviorManager.destroy()},revert:function(){this.size=this.phenome.get("birthSize"),this.generation++,this.fillStyle=Evo.Utilities.rgbToFillstyle(this.phenome.get("color_r"),this.phenome.get("color_g"),this.phenome.get("color_b")),Evo.Vector.is3d&&this.material.emissive.setRGB(this.phenome.get("color_r")/255,this.phenome.get("color_g")/255,this.phenome.get("color_b")/255),this.behaviorManager.revert()},copy:function(a){this.phenome.copy(a.phenome),this.position.copy(a.position),this.generation=a.generation},addWeightedDirection:function(a,b){isNaN(this.weightedDirection.x),a.multiplyScalar(b),this.weightedDirection.add(a),isNaN(this.weightedDirection.x)},addWeightedSpeed:function(a,b){this.weightedSpeed.speed+=a*b,this.weightedSpeed.weight+=b},draw:function(){this.scene.canvas.context.beginPath(),this.scene.canvas.context.fillStyle=this.fillStyle,this.scene.canvas.context.fillRect(this.position.x,this.position.y,this.size,this.size),this.scene.canvas.context.fill()},update:function(a){this.energy+=this.energyGenerator.get(),this.behaviorManager.update(a),this.update_position(a),this.age+=a},update_position:function(a){var b,c=0;isNaN(this.weightedDirection.x),this.speed=this.weightedSpeed.weight>0?this.weightedSpeed.speed/this.weightedSpeed.weight:0,this.size-=this.speed*this.SPEEDCOST,this.size=Math.max(this.size,1),1===this.size,this.weightedDirection.normalize(),this.direction.lerp(this.weightedDirection,Math.min(5e-4*a,1)),b=this.weightedDirection,b.copy(this.direction).multiplyScalar(a*this.speed),this.position.add(b),this.weightedDirection.multiplyScalar(0),this.weightedSpeed.speed=0,this.weightedSpeed.weight=0,isNaN(this.position.x),Evo.Vector.is3d&&(c=this.size/10,this.object3d.scale.set(2*c,.5*c,.5*c),this.object3d.rotation.y=Math.atan2(-this.direction.z,this.direction.x),this.object3d.rotation.z=Math.asin(this.direction.y))},update_keepOnScreen:function(){this.position.x%=this.bounds.x,this.position.y%=this.bounds.y,this.position.z%=this.bounds.z},setBindings:function(){new Evo.Binding("speedcost",function(){return a.prototype.SPEEDCOST},function(b){b=parseFloat(b,10),a.prototype.SPEEDCOST=b}.bind(this))}},a}(),Evo.Phenome=function(){var a=function(){this.phenotype={}};return a.prototype={mutate:function(){this.phenotype.fleeSpeed.mutate(1,400),this.phenotype.fleeDistance.mutate(1,400),this.phenotype.birthSize.mutate(5,15),this.phenotype.growthRate.mutate(1e-6,.005),this.phenotype.color_r.mutate(90,200,!0),this.phenotype.color_g.mutate(90,200,!0),this.phenotype.color_b.mutate(90,200,!0)},generate:function(){var a=200,b=10*Math.random()+5;this.phenotype.fleeSpeed=new Evo.Phenotype(1e3*Math.random()+500),this.phenotype.color_r=new Evo.Phenotype(parseInt(Math.random()*a,10)),this.phenotype.color_g=new Evo.Phenotype(parseInt(Math.random()*a,10)),this.phenotype.color_b=new Evo.Phenotype(parseInt(Math.random()*a,10)),this.phenotype.fleeDistance=new Evo.Phenotype(150*Math.random()+180),this.phenotype.birthSize=new Evo.Phenotype(b),this.phenotype.growthRate=new Evo.Phenotype(.005*Math.random())},get:function(a){return this.phenotype[a].value},copy:function(a){for(var b in a.phenotype)a.phenotype.hasOwnProperty(b)&&(this.phenotype[b].value=a.phenotype[b].value)}},a}();
//# sourceMappingURL=evolve.map.js